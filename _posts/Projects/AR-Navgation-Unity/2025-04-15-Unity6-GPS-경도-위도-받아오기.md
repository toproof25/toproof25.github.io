---
title: Unity6 GPS 경도, 위도 받아오기
description: null
date: 2025-04-15
categories:
- Projects
- AR-Navgation-Unity
tags:
- 캡스톤VR
- Unity
img: /assets/img/2025-04-15-Unity6-GPS-경도-위도-받아오기/
---
## Android XML 위치 권한 추가
- ### 위치 권한 설정
	1. Project Settings -> Player -> Publishing Settings -> *Custom Main Manifest* 체크
	  ![Custom Main Manifest 체크]({{page.img}}Custom Main Manifest 체크.webp)
	2. Project -> Plugins -> Android -> AndroidManifest.xml 파일 열기
	3.  \<manifest> 과 \<application> 사이에 해당 펄미션 추가
	   
	```xml
	<uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
	<uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />
	```

## 위치 가져오기 LocationManager
1. LocationManager.cs 를 작성 후 XR Origin에 추가
2. 위도와 경도를 출력하기 위한 TextPro 2개를 생성 후 LocationManager에 연결 
   ![TextPro 2개를 생성 후 LocationManager에 연결]({{page.img}}TextPro 2개를 생성 후 LocationManager에 연결.webp)

```cpp
using System.Collections; // 코루틴 사용을 위해 필요
using UnityEngine; // 유니티 기본 기능 사용
using TMPro; // TextMeshPro UI 사용
#if UNITY_ANDROID // Android 플랫폼에서 빌드할 때만 아래 using 문 포함
using UnityEngine.Android; // Android 특정 기능 사용 (권한 요청 등)
#endif

// 위치 정보(GPS)를 관리하는 클래스
public class LocationManager : MonoBehaviour
{
    [Header("GPS 좌표 표시용 TextMeshProUGUI")] // 인스펙터 창에서 구분을 위한 헤더
    public TextMeshProUGUI latitudeText; // 위도 표시용 텍스트 UI
    public TextMeshProUGUI longitudeText; // 경도 표시용 텍스트 UI

    private bool locationServiceRunning = false; // 위치 서비스 실행 상태 저장 변수

    // 게임 오브젝트가 활성화될 때 처음 한 번 호출됨
    private void Start()
    {
        // 위치 서비스 시작 코루틴 실행
        StartCoroutine(StartLocationService());
    }

    // 위치 서비스를 시작하는 코루틴 함수
    private IEnumerator StartLocationService()
    {
        // 권한 상태 기본값 설정 (Android 외 플랫폼은 true)
        bool permissionGranted = true;

#if UNITY_ANDROID
        // --- Android 플랫폼 전용 권한 처리 시작 ---

        // 1. 위치 정보 접근 권한 확인 (Android 전용)
        if (!Permission.HasUserAuthorizedPermission(Permission.FineLocation)) // 정밀 위치 정보 권한이 없다면
        {
            Debug.Log("위치 정보 권한 요청 중..."); // 콘솔에 로그 출력
            Permission.RequestUserPermission(Permission.FineLocation); // 사용자에게 권한 요청 팝업 표시

            // 사용자가 권한 요청에 응답할 때까지 대기
            float timeElapsed = 0f; // 경과 시간 측정용 변수
            float waitTime = 30f; // 최대 대기 시간 (초)

            // 권한이 부여되지 않았고, 최대 대기 시간을 넘지 않았다면 반복
            while (!Permission.HasUserAuthorizedPermission(Permission.FineLocation) && timeElapsed < waitTime)
            {
                yield return null; // 다음 프레임까지 대기 (CPU 부담 줄임)
                timeElapsed += Time.deltaTime; // 경과 시간 누적
                // Debug.Log("권한 응답 대기 중..."); // 필요하면 대기 로그 출력
            }

            // 대기 후 최종 권한 상태 확인
            if (!Permission.HasUserAuthorizedPermission(Permission.FineLocation)) // 여전히 권한이 없다면
            {
                Debug.LogWarning("위치 정보 접근 권한이 거부되었습니다."); // 경고 로그 출력
                permissionGranted = false; // 권한 없음 상태로 변경
                // (선택 사항) 사용자에게 권한 필요성 안내 UI 표시
                yield break; // 코루틴 실행 중단 (더 이상 진행 안 함)
            }
            else // 권한이 부여되었다면
            {
                 Debug.Log("위치 정보 권한이 승인되었습니다."); // 성공 로그 출력
                 permissionGranted = true; // 권한 있음 상태로 변경
            }
        }
        // --- Android 플랫폼 전용 권한 처리 끝 ---
#endif

        // 권한이 최종적으로 승인된 경우에만 다음 단계 진행
        if (permissionGranted)
        {
            // 2. 기기의 GPS 설정 활성화 여부 확인
            if (!Input.location.isEnabledByUser) // 사용자가 기기 설정에서 GPS를 껐다면
            {
                Debug.LogWarning("GPS가 사용자에 의해 꺼져 있습니다. 설정에서 활성화해주세요."); // 경고 로그 출력
                // (선택 사항) 사용자에게 GPS 설정 안내 UI 표시
                yield break; // 코루틴 실행 중단
            }

            // 3. Unity 위치 서비스 시작 요청
            Debug.Log("위치 서비스 시작 시도..."); // 로그 출력
            Input.location.Start(); // 위치 서비스 시작 (권한과 GPS 설정 확인 후)

            // 4. 위치 서비스 초기화 대기
            int maxWait = 20; // 최대 초기화 대기 시간 (초)
            // 서비스 상태가 '초기화 중'이고, 최대 대기 시간을 넘지 않았다면 반복
            while (Input.location.status == LocationServiceStatus.Initializing && maxWait > 0)
            {
                 Debug.Log($"GPS 초기화 대기 중... ({maxWait}초 남음)"); // 남은 시간 로그 출력
                yield return new WaitForSeconds(1); // 1초 대기
                maxWait--; // 남은 시간 감소
            }

            // 초기화 시간 초과 시
            if (maxWait <= 0)
            {
                Debug.LogWarning("GPS 초기화 시간 초과"); // 경고 로그 출력
                Input.location.Stop(); // 서비스 중지 시도
                yield break; // 코루틴 실행 중단
            }

            // 초기화 실패 시
            if (Input.location.status == LocationServiceStatus.Failed)
            {
                Debug.LogError("GPS 위치 정보를 가져올 수 없습니다. 서비스 상태: " + Input.location.status); // 에러 로그 출력
                yield break; // 코루틴 실행 중단
            }

            // 5. 위치 서비스 시작 성공
            locationServiceRunning = true; // 서비스 실행 중 상태로 변경
            Debug.Log("GPS 서비스가 성공적으로 시작됨"); // 성공 로그 출력
        }
    }

    // 매 프레임마다 호출됨
    private void Update()
    {
        // 위치 서비스가 실행 중이 아니면 아무것도 안 함
        if (!locationServiceRunning) return;

        // 위치 서비스 상태가 '실행 중'일 때만 좌표 업데이트
        if (Input.location.status == LocationServiceStatus.Running)
        {
            // 마지막으로 수신된 위치 데이터 가져오기
            var data = Input.location.lastData;

            // 위도 텍스트 UI가 연결되어 있다면 업데이트
            if (latitudeText != null)
                latitudeText.text = $"위도: {data.latitude:F6}"; // 소수점 6자리까지 표시

            // 경도 텍스트 UI가 연결되어 있다면 업데이트
            if (longitudeText != null)
                longitudeText.text = $"경도: {data.longitude:F6}"; // 소수점 6자리까지 표시
        }
        else
        {
            // 서비스가 실행 중이 아닌 다른 상태일 때 (예: 실패, 중지됨)
            // Debug.LogWarning("GPS 서비스가 실행 중이 아님. 상태: " + Input.location.status);
        }
    }

    // 스크립트나 게임 오브젝트가 비활성화될 때 호출됨
    private void OnDisable()
    {
        // 위치 서비스가 실행 중이었다면 중지
        if (locationServiceRunning)
        {
             Debug.Log("위치 서비스 중지 중..."); // 로그 출력
             Input.location.Stop(); // 위치 서비스 중지
             locationServiceRunning = false; // 상태 변경
        }
    }

    // 애플리케이션이 종료될 때 호출됨
    private void OnApplicationQuit()
    {
        // 위치 서비스가 실행 중이었다면 중지 (OnDisable과 유사하나 종료 시점)
        if (locationServiceRunning)
        {
             Debug.Log("애플리케이션 종료로 위치 서비스 중지 중..."); // 로그 출력
             Input.location.Stop(); // 위치 서비스 중지
             locationServiceRunning = false; // 상태 변경
        }
    }

    // (추가됨) 외부 스크립트에서 현재 위치 서비스 실행 상태 확인용 함수
    public bool IsServiceRunning()
    {
        return locationServiceRunning && Input.location.status == LocationServiceStatus.Running;
    }

    // (추가됨) 외부 스크립트에서 현재 GPS 좌표를 Vector2로 얻기 위한 함수
    public Vector2 GetCurrentLocation()
    {
        if (IsServiceRunning())
        {
            LocationInfo data = Input.location.lastData;
            return new Vector2(data.latitude, data.longitude);
        }
        else
        {
            // 서비스 미실행 시 기본값 또는 에러 처리 값 반환
            return Vector2.zero;
        }
    }
}
```

## 디바이드 테스트
1. 빌드 후 앱 실행 시 위치 권환 확인 메시지
   ![빌드 후 앱 실행 시 위치 권환 확인 메시지]({{page.img}}빌드 후 앱 실행 시 위치 권환 확인 메시지.webp)
2. 각 위치에 따라 위치값이 바뀌는 것을 확인할 수 있었다
   ![각 위치에 따라 위치값이 바뀌는 것을 확인1]({{page.img}}각 위치에 따라 위치값이 바뀌는 것을 확인1.webp)
   
   ![각 위치에 따라 위치값이 바뀌는 것을 확인2]({{page.img}}각 위치에 따라 위치값이 바뀌는 것을 확인2.webp)





---
## 링크 및 참고자료

##### 링크 문서
- 

##### 참고자료(출처)
- 



